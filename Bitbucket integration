image: python:3.9  # Use Python environment

pipelines:
  branches:
    main:  # Trigger only on changes to the main branch
      - step:
          name: Execute SQL in Snowflake
          script:
            - apt-get update && apt-get install -y libssl-dev  # Ensure dependencies
            - pip install snowflake-connector-python

            # Set Snowflake credentials
            - export SNOWFLAKE_ACCOUNT="xyz123.us-east-1"  # Replace with your details
            - export SNOWFLAKE_USER="your_user"
            - export SNOWFLAKE_DATABASE="your_database"
            - export SNOWFLAKE_SCHEMA="your_schema"
            - export SNOWFLAKE_WAREHOUSE="your_warehouse"

            # Create a temporary private key file
            - echo "-----BEGIN PRIVATE KEY-----" > /tmp/private_key.p8
            - echo "$SNOWFLAKE_PRIVATE_KEY" >> /tmp/private_key.p8
            - echo "-----END PRIVATE KEY-----" >> /tmp/private_key.p8
            - export SNOWFLAKE_PRIVATE_KEY_PATH="/tmp/private_key.p8"

            # Identify the latest SQL file added
            - SQL_FILE=$(git diff --name-only HEAD^ HEAD | grep '\.sql' | tail -n 1)
            - if [ -n "$SQL_FILE" ]; then python execute_sql.py "$SQL_FILE"; fi
