image: python:3.9

pipelines:
  custom:
    manual-deploy-dev:
      - step:
          name: Manual Deploy to Dev
          script:
            # Install GPG, git, Python tools
            - apt-get update && apt-get install -y gnupg git python3-pip

            # Upgrade pip and install required Python libs
            - pip install --upgrade pip
            - pip install snowflake-connector-python cryptography pyyaml

            # Prepare GPG home directory
            - mkdir -p ~/.gnupg
            - chmod 700 ~/.gnupg

            # Optional: Configure GPG to use loopback for passphrase input
            - echo "use-agent" >> ~/.gnupg/gpg.conf
            - echo "pinentry-mode loopback" >> ~/.gnupg/gpg.conf

            # Import base64-encoded private key stored as Bitbucket secret variable
            - echo "$GPG_PRIVATE_KEY" | base64 --decode | gpg --batch --yes --import

            # Decrypt the Snowflake private key file using the passphrase
            - gpg --batch --yes --passphrase "$GPG_PASSPHRASE" \
                --output /tmp/snowflake_private_key.p8 \
                --decrypt serv_source_dev_rsa_key_encr.p8.secret

            # Run your SQL script using the decrypted key
            - python execute_sql.py
