-- Step 1: Create an anomaly detection model using the sum_of_sales column
-- This uses Snowflake's built-in ML to automatically choose the algorithm (e.g., histogram or isolation forest)
CREATE OR REPLACE SNOWFLAKE.ML.ANOMALY_DETECTION my_sales_anomaly_detector()
  FROM (
    SELECT sum_of_sales
    FROM your_schema.your_sales_table
  );

-- Step 2: Predict anomalies using the trained detector
-- The result will add a column: 
--   anomaly_prediction = -1 for anomaly, 
--   anomaly_prediction = 1 for normal
SELECT 
  year_quarter,
  sum_of_sales,
  my_sales_anomaly_detector!PREDICT(sum_of_sales) AS anomaly_prediction
FROM your_schema.your_sales_table;

-- Step 3 (Optional): Save the results to a new table for analysis or reporting
CREATE OR REPLACE TABLE your_schema.sales_with_anomalies AS
SELECT 
  year_quarter,
  sum_of_sales,
  my_sales_anomaly_detector!PREDICT(sum_of_sales) AS anomaly_prediction
FROM your_schema.your_sales_table;
