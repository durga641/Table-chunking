use role sysadmin;

-- External Stage
CREATE or replace STAGE SYS_UTILS.SOURCE.TABLE_BACKUP_STAGE 
URL = 's3://datÃ¦ng-snowflake-prd-ascap/snowflake/' 
CREDENTIALS = (AWS_KEY_ID = '***************' AWS_SECRET_KEY = '*************');

-- FileFormat stage
CREATE OR REPLACE FILE FORMAT SYS_UTILS.SOURCE.TABLE_BACKUP_FF 
TYPE = 'CSV' 
COMPRESSION = 'AUTO' 
FIELD_DELIMITER = ',' 
RECORD_DELIMITER = '\n' 
SKIP_HEADER = 0 
FIELD_OPTIONALLY_ENCLOSED_BY = '\042' 
TRIM_SPACE = FALSE 
ERROR_ON_COLUMN_COUNT_MISMATCH = TRUE 
ESCAPE = '\134' 
ESCAPE_UNENCLOSED_FIELD = '\134'
DATE_FORMAT = 'AUTO' 
TIMESTAMP_FORMAT = 'AUTO' 
NULL_IF = ('NULL');

-- Table DDL
create or replace TABLE SYS_UTILS.SOURCE.tablebkup_workload (
    DBNAME VARCHAR(100),
    SCHEMANAME VARCHAR(100),
    TABLENAME VARCHAR(100),
    FREQUENCY VARCHAR(100),
    LASTBKUPDT DATE,
    DEL_FL VARCHAR(1),
    FULL_INCR VARCHAR(10),
    INCR_WHERE_CLAUSE VARCHAR(100)
);


copy_script = f'''
snowsql -c serv_source -o exit_on_error=true -q "
USE DATABASE {db_nm}; 
USE SCHEMA {sch_nm}; 

COPY INTO @SYS_UTILS_SOURCE.TABLE_BACKUP_STAGE/{csv_file}.gz
FROM (SELECT * FROM {table_name})
FILE_FORMAT = (FORMAT_NAME = 'SYS_UTILS_SOURCE.TABLE_BACKUP_FF')
OVERWRITE = TRUE
SINGLE = TRUE;  -- Ensures a single file
"
'''



import os
import glob

def clean_old_files(base_path, db_nm, sch_nm, tab_nm):
    # Construct the file path pattern
    file_pattern = os.path.join(base_path, f"{db_nm}/{sch_nm}/{tab_nm}/{tab_nm}*")
    
    # Get the list of matching files sorted by modification time (newest first)
    files = sorted(glob.glob(file_pattern), key=os.path.getmtime, reverse=True)
    
    # If there are more than 5 files, keep the latest 4 and delete the rest
    if len(files) > 5:
        files_to_delete = files[4:]  # Keep the latest 4, delete the rest
        for file in files_to_delete:
            os.remove(file)
            print(f"Deleted: {file}")
    else:
        print("No action required. Files are 4 or less.")

# Example Usage
base_path = "/your/s3/mount/path"  # Change this to the actual path where files are stored
db_nm = "database"
sch_nm = "schema"
tab_nm = "table"

clean_old_files(base_path, db_nm, sch_nm, tab_nm)
