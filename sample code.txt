use role sysadmin;

-- External Stage
CREATE or replace STAGE SYS_UTILS.SOURCE.TABLE_BACKUP_STAGE 
URL = 's3://dat√¶ng-snowflake-prd-ascap/snowflake/' 
CREDENTIALS = (AWS_KEY_ID = '***************' AWS_SECRET_KEY = '*************');

-- FileFormat stage
CREATE OR REPLACE FILE FORMAT SYS_UTILS.SOURCE.TABLE_BACKUP_FF 
TYPE = 'CSV' 
COMPRESSION = 'AUTO' 
FIELD_DELIMITER = ',' 
RECORD_DELIMITER = '\n' 
SKIP_HEADER = 0 
FIELD_OPTIONALLY_ENCLOSED_BY = '\042' 
TRIM_SPACE = FALSE 
ERROR_ON_COLUMN_COUNT_MISMATCH = TRUE 
ESCAPE = '\134' 
ESCAPE_UNENCLOSED_FIELD = '\134'
DATE_FORMAT = 'AUTO' 
TIMESTAMP_FORMAT = 'AUTO' 
NULL_IF = ('NULL');

-- Table DDL
create or replace TABLE SYS_UTILS.SOURCE.tablebkup_workload (
    DBNAME VARCHAR(100),
    SCHEMANAME VARCHAR(100),
    TABLENAME VARCHAR(100),
    FREQUENCY VARCHAR(100),
    LASTBKUPDT DATE,
    DEL_FL VARCHAR(1),
    FULL_INCR VARCHAR(10),
    INCR_WHERE_CLAUSE VARCHAR(100)
);


copy_script = f'''
snowsql -c serv_source -o exit_on_error=true -q "
USE DATABASE {db_nm}; 
USE SCHEMA {sch_nm}; 

COPY INTO @SYS_UTILS_SOURCE.TABLE_BACKUP_STAGE/{csv_file}.gz
FROM (SELECT * FROM {table_name})
FILE_FORMAT = (FORMAT_NAME = 'SYS_UTILS_SOURCE.TABLE_BACKUP_FF')
OVERWRITE = TRUE
SINGLE = TRUE;  -- Ensures a single file
"
'''
